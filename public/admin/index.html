<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Blog Admin - Decap CMS</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      /* Clean admin styling */
      .ai-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin: 4px;
        transition: all 0.3s ease;
      }
      .ai-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
    </style>
  </head>
  <body>
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/admin/";
            });
          }
        });
      }
    </script>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <script>
      // Simple AI Enhancement Functions
      async function enrichWithAI() {
        // Get title and content
        let titleValue = '';
        let bodyValue = '';
        
        // Find title field
        const titleField = document.querySelector('input[name="title"]') || 
                          document.querySelector('[data-testid*="title"]') ||
                          document.querySelector('input[placeholder*="title" i]');
        if (titleField) titleValue = titleField.value || '';
        
        // Find body content
        const codeMirrors = document.querySelectorAll('.CodeMirror');
        for (const cm of codeMirrors) {
          if (cm.CodeMirror) {
            bodyValue = cm.CodeMirror.getValue();
            break;
          }
        }
        
        if (!titleValue || !bodyValue) {
          alert('❌ Please add a title and some content first!');
          return;
        }

        try {
          const response = await fetch('/api/ai-enrich', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: titleValue, content: bodyValue })
          });
          
          const data = await response.json();
          
          if (data.error) {
            alert('❌ AI Error: ' + data.error);
            return;
          }

          // Update fields
          if (data.summary) {
            const summaryField = document.querySelector('textarea[name="summary"]');
            if (summaryField) {
              summaryField.value = data.summary;
              summaryField.dispatchEvent(new Event('input', { bubbles: true }));
            }
          }
          
          if (data.category) {
            const categoryField = document.querySelector('select[name="category"]');
            if (categoryField) {
              categoryField.value = data.category;
              categoryField.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
          
          if (data.meta_description) {
            const metaField = document.querySelector('textarea[name="meta_description"]');
            if (metaField) {
              metaField.value = data.meta_description;
              metaField.dispatchEvent(new Event('input', { bubbles: true }));
            }
          }
          
          let message = '✨ AI enrichment complete!\n\n';
          if (data.summary) message += `📝 Summary: ${data.summary}\n`;
          if (data.category) message += `📂 Category: ${data.category}\n`;
          if (data.meta_description) message += `🔍 Meta: ${data.meta_description}\n`;
          if (data.tags) message += `🏷️ Suggested tags: ${data.tags.join(', ')} (add manually)`;
          
          alert(message);
          
        } catch (error) {
          console.error('AI enrichment error:', error);
          alert('❌ Failed to enrich with AI: ' + error.message);
        }
      }

      // Add AI button when CMS loads
      function addAIButton() {
        if (document.querySelector('.ai-enhance-btn')) return;

        // Find toolbar location
        const toolbar = document.querySelector('.cms-editor') || 
                       document.querySelector('[class*="editor"]') ||
                       document.body;

        if (toolbar) {
          const aiButton = document.createElement('button');
          aiButton.className = 'ai-button ai-enhance-btn';
          aiButton.innerHTML = '🤖 AI Enrich';
          aiButton.onclick = enrichWithAI;
          aiButton.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
          
          document.body.appendChild(aiButton);
        }
      }

      // Wait for CMS to load
      let attempts = 0;
      function waitForCMS() {
        attempts++;
        if (attempts > 10) return;
        
        if (document.querySelector('.cms-editor') || document.querySelector('.CodeMirror')) {
          addAIButton();
        } else {
          setTimeout(waitForCMS, 1000);
        }
      }

      setTimeout(waitForCMS, 2000);

      // Clean preview template - no raw HTML shown
      CMS.registerPreviewTemplate('posts', ({ entry, widgetFor }) => {
        const title = entry.getIn(['data', 'title']) || 'Untitled Post';
        const summary = entry.getIn(['data', 'summary']) || '';
        const category = entry.getIn(['data', 'category']) || 'Personal';
        const tags = entry.getIn(['data', 'tags']) || [];
        const body = widgetFor('body');
        
        return h('div', { style: { maxWidth: '800px', margin: '0 auto', padding: '20px', fontFamily: 'system-ui' } }, [
          h('div', { style: { background: '#f8fafc', padding: '16px', borderRadius: '8px', marginBottom: '20px', borderLeft: '4px solid #4f46e5' } }, [
            h('div', { style: { color: '#6366f1', fontSize: '12px', fontWeight: '600', textTransform: 'uppercase', marginBottom: '8px' } }, category),
            h('h1', { style: { margin: '0 0 12px 0', color: '#1f2937' } }, title),
            summary && h('p', { style: { color: '#6b7280', margin: '0', fontStyle: 'italic' } }, summary),
            tags.length > 0 && h('div', { style: { marginTop: '12px' } }, 
              tags.map(tag => h('span', { 
                style: { 
                  background: '#e5e7eb', 
                  color: '#374151', 
                  padding: '2px 8px', 
                  borderRadius: '12px', 
                  fontSize: '12px', 
                  marginRight: '8px' 
                } 
              }, tag))
            )
          ]),
          h('article', { style: { lineHeight: '1.6', color: '#374151' } }, body)
        ]);
      });
    </script>
  </body>
</html>