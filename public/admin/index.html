<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Blog Admin - Enhanced CMS</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      /* Enhanced admin styling */
      .ai-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin: 4px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .ai-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      .ai-analyze { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
      .ai-social { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
      .ai-toolbar {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border: 1px solid #e2e8f0;
        max-width: 300px;
      }
      .ai-results {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.5;
      }
      .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              // Remove redirect to prevent loop - CMS will load here
              console.log("User logged in, CMS should load");
            });
          }
        });
      }
    </script>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <script>
      // Enhanced AI Enhancement Functions
      let currentTitle = '';
      let currentContent = '';
      
      function getTitleAndContent() {
        // Find title field
        const titleField = document.querySelector('input[name="title"]') || 
                          document.querySelector('[data-testid*="title"]') ||
                          document.querySelector('input[placeholder*="title" i]');
        currentTitle = titleField ? titleField.value || '' : '';
        
        // Find body content
        const codeMirrors = document.querySelectorAll('.CodeMirror');
        for (const cm of codeMirrors) {
          if (cm.CodeMirror) {
            currentContent = cm.CodeMirror.getValue();
            break;
          }
        }
        
        return { title: currentTitle, content: currentContent };
      }
      
      function showLoading(button, text = 'Processing...') {
        button.innerHTML = `<span class="loading-spinner"></span> ${text}`;
        button.disabled = true;
      }
      
      function hideLoading(button, originalText) {
        button.innerHTML = originalText;
        button.disabled = false;
      }
      
      function showResults(results, title) {
        const toolbar = document.querySelector('.ai-toolbar');
        let resultsDiv = toolbar.querySelector('.ai-results');
        if (!resultsDiv) {
          resultsDiv = document.createElement('div');
          resultsDiv.className = 'ai-results';
          toolbar.appendChild(resultsDiv);
        }
        
        resultsDiv.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 8px; color: #2d3748;">${title}</div>
          <div style="white-space: pre-wrap; color: #4a5568;">${results}</div>
        `;
      }

      // Enhanced Enrich Function
      async function enrichWithAI() {
        const { title, content } = getTitleAndContent();
        
        if (!title || !content) {
          alert('‚ùå Please add a title and some content first!');
          return;
        }

        const button = document.querySelector('.ai-enrich');
        showLoading(button, 'Enriching...');

        try {
          const response = await fetch('/api/ai-enrich', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, content })
          });
          
          const data = await response.json();
          
          if (data.error) {
            alert('‚ùå AI Error: ' + data.error);
            return;
          }

          // Update fields
          if (data.summary) {
            const summaryField = document.querySelector('textarea[name="summary"]');
            if (summaryField) {
              summaryField.value = data.summary;
              summaryField.dispatchEvent(new Event('input', { bubbles: true }));
            }
          }
          
          if (data.category) {
            const categoryField = document.querySelector('select[name="category"]');
            if (categoryField) {
              categoryField.value = data.category;
              categoryField.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
          
          if (data.meta_description) {
            const metaField = document.querySelector('textarea[name="meta_description"]');
            if (metaField) {
              metaField.value = data.meta_description;
              metaField.dispatchEvent(new Event('input', { bubbles: true }));
            }
          }
          
          let message = '‚ú® Enrichment Complete!\\n\\n';
          if (data.summary) message += `üìù Summary: ${data.summary}\\n\\n`;
          if (data.category) message += `üìÇ Category: ${data.category}\\n\\n`;
          if (data.meta_description) message += `üîç Meta: ${data.meta_description}\\n\\n`;
          if (data.tags) message += `üè∑Ô∏è Suggested tags: ${data.tags.join(', ')} (add manually)`;
          
          showResults(message, 'ü§ñ AI Enrichment Results');
          
        } catch (error) {
          console.error('AI enrichment error:', error);
          alert('‚ùå Failed to enrich with AI: ' + error.message);
        } finally {
          hideLoading(button, 'ü§ñ AI Enrich');
        }
      }

      // New Analyze Function
      async function analyzeContent() {
        const { title, content } = getTitleAndContent();
        
        if (!content || content.length < 100) {
          alert('‚ùå Please add at least 100 characters of content to analyze!');
          return;
        }

        const button = document.querySelector('.ai-analyze');
        showLoading(button, 'Analyzing...');

        try {
          const response = await fetch('/api/ai-analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content, targetAudience: 'general', tone: 'professional' })
          });
          
          const data = await response.json();
          
          if (data.error) {
            alert('‚ùå Analysis Error: ' + data.error);
            return;
          }

          const analysis = data.analysis;
          let results = `üìä Readability Score: ${analysis.readability_score}/10\\n`;
          results += `üìñ Word Count: ${data.word_count}\\n`;
          results += `‚è±Ô∏è Reading Time: ${data.reading_time} min\\n\\n`;
          
          if (analysis.suggestions) {
            results += 'üí° Suggestions:\\n';
            analysis.suggestions.forEach(suggestion => {
              results += `‚Ä¢ ${suggestion}\\n`;
            });
            results += '\\n';
          }
          
          if (analysis.seo_suggestions) {
            results += 'üîç SEO Tips:\\n';
            analysis.seo_suggestions.forEach(tip => {
              results += `‚Ä¢ ${tip}\\n`;
            });
          }
          
          showResults(results, 'üìä Content Analysis');
          
        } catch (error) {
          console.error('AI analyze error:', error);
          alert('‚ùå Failed to analyze content: ' + error.message);
        } finally {
          hideLoading(button, 'üìä Analyze');
        }
      }

      // New Social Media Function
      async function generateSocial() {
        const { title, content } = getTitleAndContent();
        
        if (!title || !content) {
          alert('‚ùå Please add a title and content first!');
          return;
        }

        const button = document.querySelector('.ai-social');
        showLoading(button, 'Creating...');

        try {
          const response = await fetch('/api/ai-social', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, content, style: 'engaging' })
          });
          
          const data = await response.json();
          
          if (data.error) {
            alert('‚ùå Social Error: ' + data.error);
            return;
          }

          const posts = data.social_posts;
          let results = 'üì± Social Media Posts:\\n\\n';
          
          if (posts.twitter) results += `üê¶ Twitter:\\n${posts.twitter}\\n\\n`;
          if (posts.linkedin) results += `üíº LinkedIn:\\n${posts.linkedin}\\n\\n`;
          if (posts.instagram) results += `üì∏ Instagram:\\n${posts.instagram}\\n\\n`;
          if (posts.facebook) results += `üë• Facebook:\\n${posts.facebook}\\n\\n`;
          if (posts.threads) results += `üßµ Threads:\\n${posts.threads}`;
          
          showResults(results, 'üì± Social Media Posts');
          
        } catch (error) {
          console.error('AI social error:', error);
          alert('‚ùå Failed to generate social posts: ' + error.message);
        } finally {
          hideLoading(button, 'üì± Social');
        }
      }

      // Enhanced toolbar creation
      function createEnhancedToolbar() {
        if (document.querySelector('.ai-toolbar')) return;

        const toolbar = document.createElement('div');
        toolbar.className = 'ai-toolbar';
        toolbar.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 12px; color: #2d3748; text-align: center;">
            ‚ú® AI Writing Assistant
          </div>
          <div style="display: grid; gap: 8px;">
            <button class="ai-button ai-enrich" onclick="enrichWithAI()">ü§ñ AI Enrich</button>
            <button class="ai-button ai-analyze" onclick="analyzeContent()">üìä Analyze</button>
            <button class="ai-button ai-social" onclick="generateSocial()">üì± Social</button>
          </div>
        `;
        
        document.body.appendChild(toolbar);
      }

      // Wait for CMS to load
      let attempts = 0;
      function waitForCMS() {
        attempts++;
        if (attempts > 15) return;
        
        if (document.querySelector('.cms-editor') || document.querySelector('.CodeMirror')) {
          createEnhancedToolbar();
        } else {
          setTimeout(waitForCMS, 1000);
        }
      }

      setTimeout(waitForCMS, 2000);

      // Enhanced preview template with AI status
      CMS.registerPreviewTemplate('posts', ({ entry, widgetFor }) => {
        const title = entry.getIn(['data', 'title']) || 'Untitled Post';
        const summary = entry.getIn(['data', 'summary']) || '';
        const category = entry.getIn(['data', 'category']) || 'Personal';
        const tags = entry.getIn(['data', 'tags']) || [];
        const metaDescription = entry.getIn(['data', 'meta_description']) || '';
        const featured = entry.getIn(['data', 'featured']) || false;
        const body = widgetFor('body');
        
        // Detect AI enhancements
        const hasAIEnhancements = summary || metaDescription || tags.length > 0;
        
        return h('div', { 
          style: { 
            maxWidth: '800px', 
            margin: '0 auto', 
            padding: '20px', 
            fontFamily: 'system-ui',
            lineHeight: '1.6'
          } 
        }, [
          // AI Enhancement Status
          hasAIEnhancements ? h('div', { 
            style: { 
              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', 
              color: 'white', 
              padding: '12px 16px', 
              borderRadius: '8px', 
              marginBottom: '16px',
              fontSize: '14px',
              fontWeight: '600',
              textAlign: 'center'
            } 
          }, 'ü§ñ AI Enhanced Content Preview') : h('div', { 
            style: { 
              background: '#fef3c7', 
              border: '1px solid #f59e0b', 
              color: '#92400e',
              padding: '12px 16px', 
              borderRadius: '8px', 
              marginBottom: '16px',
              fontSize: '14px',
              textAlign: 'center'
            } 
          }, 'üí° Tip: Use "ü§ñ AI Enrich" to enhance this content!'),
          
          // Header section
          h('div', { 
            style: { 
              background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)', 
              padding: '24px', 
              borderRadius: '12px', 
              marginBottom: '32px', 
              borderLeft: '4px solid #4f46e5' 
            } 
          }, [
            h('div', { 
              style: { 
                color: '#6366f1', 
                fontSize: '12px', 
                fontWeight: '600', 
                textTransform: 'uppercase', 
                marginBottom: '8px' 
              } 
            }, category + (featured ? ' ‚Ä¢ ‚≠ê Featured' : '')),
            h('h1', { 
              style: { 
                margin: '0 0 16px 0', 
                color: '#1f2937', 
                fontSize: '2.5rem',
                fontWeight: '700'
              } 
            }, title),
            summary && h('p', { 
              style: { 
                color: '#6b7280', 
                margin: '0 0 16px 0', 
                fontStyle: 'italic',
                fontSize: '1.1rem'
              } 
            }, summary),
            metaDescription && h('div', { 
              style: { 
                background: '#f3f4f6', 
                padding: '8px 12px', 
                borderRadius: '6px', 
                fontSize: '12px', 
                color: '#6b7280',
                marginBottom: '12px'
              } 
            }, `SEO Description: ${metaDescription}`),
            tags.length > 0 && h('div', { 
              style: { marginTop: '16px' } 
            }, 
              tags.map(tag => h('span', { 
                style: { 
                  background: '#e5e7eb', 
                  color: '#374151', 
                  padding: '4px 12px', 
                  borderRadius: '16px', 
                  fontSize: '12px', 
                  marginRight: '8px',
                  fontWeight: '500'
                } 
              }, tag))
            )
          ]),
          // Content section
          h('article', { 
            style: { 
              lineHeight: '1.8', 
              color: '#374151',
              fontSize: '1.1rem'
            } 
          }, body)
        ]);
      });
    </script>
  </body>
</html>